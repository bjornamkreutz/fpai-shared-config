<?xml version="1.0" encoding="UTF-8"?>
<!--
  The following properties should be set:
  - ant.project.name: Should always be set to something sensible (will be used in the directories)
  - targetversion: The current version of the build, e.g. 13.10
  - project.title: The title that will be shown in the javadoc
  - deployment-repos: An optional list of repositories that will be used to create the deployment
-->
<project name="fpai.template" default="build">
	<property name="releasedir" value="/var/www/html/releases" />
	<property name="baseDir" value="${releasedir}/${ant.project.name}" />

	<!-- TODO: include the appstore again when it is fixed -->
	<fileset id="build" dir="..">
		<include name="*/build.xml" />
		<exclude name="cnf*/*" />
		<exclude name="*appstore*/*" />
	</fileset>

	<!-- TODO: include the appstore again when it is fixed -->
	<fileset id="release" dir="..">
		<include name="*/build.xml" />
		<exclude name="cnf*/*" />
		<exclude name="*.test/*" />
		<exclude name="*appstore*/*" />
	</fileset>

	<target name="echo">
		<subant target="echo">
			<fileset refId="build" />
		</subant>
	</target>
	
	<target name="build">
		<subant target="build">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="release">
		<subant target="release">
			<fileset refId="release" />
		</subant>
	</target>

	<target name="coverage-report">
		<subant target="coverage-report">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="test" depends="build">
		<subant target="test">
			<fileset dir="..">
				<include name="*.test/build.xml" />
			</fileset>
		</subant>
	</target>

	<target name="clean">
		<delete dir="release" />
		<mkdir dir="release" />
		<subant target="clean">
			<fileset refId="build" />
		</subant>
	</target>
	
	<target name="checkstyle">
		<subant target="checkstyle">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="publishrelease" depends="release">
		<delete dir="${baseDir}/${version}/repo" />
		<mkdir dir="${baseDir}/${version}/repo" />
		<copy todir="${baseDir}/${version}/repo">
			<fileset dir="release" />
		</copy>
		
		<zip basedir=".." destfile="${baseDir}/${version}/${ant.project.name}-sources-${version}.zip">
			<include name="*/src/**"/>
			<include name="*/test/**"/>
			<include name="*/res/**"/>
			<include name="*/*.bnd"/>
			<include name="*/build*.xml"/>
			<include name="cnf*/**"/>
			
			<exclude name="cnf*/cache/**"/>
			<exclude name="cnf*/tools/**"/>
			<exclude name="cnf*/release/**"/>
			<!-- TODO: skip the appstore -->
			<exclude name="flexiblepower.appstore.*/**"/>
		</zip>
		
		<zip basedir="release" destfile="${baseDir}/${version}/${ant.project.name}-bundles-${version}.zip">
			<include name="**" />
		</zip>
	</target>
	
	<fileset dir=".." id="javadoc_files">
		<include name="*.api*/**/*.java" />
		<exclude name="*.test/*" />
		<exclude name="**/*Test.java" />
	</fileset>
	<pathconvert refid="javadoc_files" property="fileset.notempty" setonempty="false" />
	
	<target name="publishjavadoc" if="fileset.notempty">
		<delete dir="${baseDir}/${version}/javadoc" />
		<mkdir dir="${baseDir}/${version}/javadoc" />
		<javadoc encoding="UTF-8" destdir="${baseDir}/${version}/javadoc" windowtitle="${project.title}">
			<classpath location="${baseDir}/../cnf.shared/bnd/biz.aQute.bnd-2.1.0.jar" />
			<fileset refid="javadoc_files" />
		</javadoc>
	</target>

	<target name="deployment" depends="release" if="deployment-repos">
		<property name="felix" value="felix" />
		<delete dir="${felix}" />
		<mkdir dir="${felix}" />
		<mkdir dir="${felix}/etc" />
		<mkdir dir="${felix}/base_bundles" />
		<mkdir dir="${felix}/fpai_bundles" />
		
		<get dest="${felix}/base_bundles" src="http://apache.proserve.nl/felix/org.apache.felix.main-4.2.1.jar" />
		<antcall target="downloadRepo">
			<param name="baseUrl" value="http://openemf.labsgn.tno.nl/ext-repo"/>
			<param name="targetDir" value="${felix}/base_bundles"/>
			<param name="gzipped" value="true"/>
		</antcall>

		<foreach list="${deployment-repos}" delimiter="," param="baseUrl" target="downloadRepo">
			<param name="targetDir" value="${felix}/fpai_bundles"/>
		</foreach>
		
		<copy todir="${felix}/fpai_bundles" flatten="true">
			<fileset dir="${felix}/../release/">
				<include name="*/*.jar"/>
			</fileset>
		</copy>

		<!-- copy the configuration -->
		<copy todir="${felix}/etc">
			<fileset dir="${felix}/../deployment" />
		</copy>
		
		<echo file="${felix}/run.bat">
@echo off
title ${project.title}
echo ${project.title}
echo Running from %CD%

start "${project.title}" java ^
      -Djava.security.policy=etc/all.policy ^
      -Dfelix.config.properties=file:etc/config.properties ^
      -Dfelix.cm.dir="%CD%\config" ^
      -Dlogback.configurationFile=./etc/logback.xml ^
      -jar base_bundles/org.apache.felix.main-4.2.1.jar
		</echo>
		
		<zip basedir="${felix}" destfile="${baseDir}/${version}/${ant.project.name}-felix-runtime-${version}.zip">
			<include name="**" />
		</zip>
	</target>
	
	<taskdef classpath="../cnf.shared/bnd/ant-contrib-1.0b3.jar" resource="net/sf/antcontrib/antlib.xml" />
	
	<target name="downloadRepo">
		<if>
			<equals arg1="${gzipped}" arg2="true"/>
			<then>
				<get src="${baseUrl}/index.xml.gz" dest="${targetDir}" />
				<gunzip src="${targetDir}/index.xml.gz"/>
				<delete file="${targetDir}/index.xml.gz"/>
			</then>
			<else>
				<get src="${baseUrl}/index.xml" dest="${targetDir}" />
			</else>
		</if>
		
		<loadfile srcfile="${targetDir}/index.xml" property="urls">
			<filterchain>
				<linecontainsregexp>
					<regexp pattern="attribute name='url'" />
				</linecontainsregexp>
				<replaceregex pattern=".*value='(.+)'.*" replace="\1"/>
				<suffixlines suffix=","/>
				<striplinebreaks/>
			</filterchain>
		</loadfile>
		<delete file="${targetDir}/index.xml" />

		<foreach list="${urls}" delimiter="," param="file" target="download" />
	</target>
		
	<target name="download">
		<get dest="${targetDir}" src="${baseUrl}/${file}" />
	</target>
	
	<target name="distribute">
		<delete dir="../cnf/release" />
		<mkdir dir="../cnf/release" />
		<delete dir="../cnf/cache" />
		<mkdir dir="../cnf/cache" />
		
		<subant target="distribute">
			<fileset refId="build" />
		</subant>
		<subant target="test">
			<fileset dir="..">
				<include name="*.test/build.xml" />
			</fileset>
		</subant>
			
		<antcall target="publishrelease" />
		<antcall target="publishjavadoc" />
		<antcall target="deployment" />
	</target>
	
	<target name="snapshot">
		<property name="version" value="${targetversion}-SNAPSHOT" />
		<antcall target="distribute" />
	</target>

	<target name="nightly">
		<property name="version" value="${targetversion}-${DSTAMP}-NIGHTLY" />
		<antcall target="distribute" />
	</target>

	<target name="really-do-release">
		<property name="version" value="${targetversion}" />
		<antcall target="distribute" />
	</target>
</project>
