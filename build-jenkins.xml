<?xml version="1.0" encoding="UTF-8"?>
<!--
  The following properties should be set:
  - ant.project.name: Should always be set to something sensible (will be used in the directories)
  - targetversion: The current version of the build, e.g. 13.10
  - project.title: The title that will be shown in the javadoc
-->
<project name="fpai.template" default="build">
	<dirname property="projectdir" file="${ant.file}" />
	<dirname property="workspacedir" file="${projectdir}" />

	<!-- TODO: include the appstore again when it is fixed -->
	<fileset id="build" dir="${workspacedir}">
		<include name="*/build.xml" />
		<exclude name="cnf*/*" />
		<exclude name="*appstore*/*" />
	</fileset>

	<!-- TODO: include the appstore again when it is fixed -->
	<fileset id="release" dir="${workspacedir}">
		<include name="*/build.xml" />
		<exclude name="cnf*/*" />
		<exclude name="*.test/*" />
		<exclude name="*appstore*/*" />
	</fileset>

	<target name="init" unless="init.done">
		<fail unless="targetversion" message="Missing the 'targetversion' parameter, should the target be called directly?" />
		<fail unless="project.title" message="Missing the 'project.title' parameter, should the target be called directly?" />

		<condition property="releasedir" value="C:\temp\releases">
			<os family="windows" />
		</condition>
		<condition property="releasedir" value="/var/www/html/releases">
			<os family="unix" />
		</condition>
		<fail unless="releasedir">No release directory can be configured for this OS!</fail>

		<property name="baseDir" value="${releasedir}/${ant.project.name}" />

		<taskdef resource="nl/tno/bnd/repodownloader/ant/taskdef.properties" classpath="${workspacedir}/cnf.shared/tools/repo-downloader.jar" />
		<tstamp />

		<available property="deployment.present" file="${workspacedir}/cnf/deployment/config.properties" />

		<property name="init.done" value="true" />
	</target>

	<target name="echo" depends="init">
		<subant target="echo">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="build" depends="init" unless="build.done">
		<subant target="build">
			<fileset refId="build" />
		</subant>
		<property name="build.done" value="true" />
	</target>

	<target name="release" depends="build" unless="release.done">
		<subant target="release">
			<fileset refId="release" />
		</subant>
		<property name="release.done" value="true" />
	</target>

	<target name="coverage-report" depends="build">
		<subant target="coverage-report">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="test" depends="build">
		<subant target="test">
			<fileset dir="..">
				<include name="*.test/build.xml" />
			</fileset>
		</subant>
	</target>

	<target name="clean" depends="init">
		<delete dir="${workspacedir}/cnf/releae" />
		<delete dir="${workspacedir}/cnf/felix" />
		<mkdir dir="${workspacedir}/cnf/release" />
		<subant target="clean">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="checkstyle" depends="build">
		<subant target="checkstyle">
			<fileset refId="build" />
		</subant>
	</target>

	<target name="publishrelease" depends="release">
		<delete dir="${baseDir}/${version}/repo" />
		<mkdir dir="${baseDir}/${version}/repo" />
		<copy todir="${baseDir}/${version}/repo">
			<fileset dir="release" />
		</copy>

		<zip basedir="${workspacedir}" destfile="${baseDir}/${version}/${ant.project.name}-sources-${version}.zip">
			<include name="*/src/**"/>
			<include name="*/test/**"/>
			<include name="*/res/**"/>
			<include name="*/*.bnd"/>
			<include name="*/build*.xml"/>
			<include name="cnf*/**"/>

			<exclude name="cnf*/bnd/**"/>
			<exclude name="cnf*/cache/**"/>
			<exclude name="cnf*/felix/**"/>
			<exclude name="cnf*/lib/**"/>
			<exclude name="cnf*/tools/**"/>
			<exclude name="cnf*/release/**"/>
			<!-- TODO: skip the appstore -->
			<exclude name="flexiblepower.appstore.*/**"/>
		</zip>

		<zip basedir="release" destfile="${baseDir}/${version}/${ant.project.name}-bundles-${version}.zip">
			<include name="**" />
		</zip>
	</target>

	<target name="publishjavadoc" depends="release" if="fileset.notempty">
		<fileset dir=".." id="javadoc_files">
			<include name="*.api*/**/*.java" />
			<exclude name="*.test/*" />
			<exclude name="**/*Test.java" />
		</fileset>
		<pathconvert refid="javadoc_files" property="fileset.notempty" setonempty="false" />

		<delete dir="${baseDir}/${version}/javadoc" />
		<mkdir dir="${baseDir}/${version}/javadoc" />
		<javadoc encoding="UTF-8" destdir="${baseDir}/${version}/javadoc" windowtitle="${project.title}">
			<classpath location="${workspacedir}/cnf.shared/bnd/biz.aQute.bnd-2.1.0.jar" />
			<fileset refid="javadoc_files" />
		</javadoc>
	</target>

	<target name="deployment-extras">
	</target>
	
	<target name="deployment" depends="release" if="deployment.present">
		<property name="felix" value="${workspacedir}/cnf/felix" />

		<mkdir dir="${felix}/etc" />
		<mkdir dir="${felix}/base_bundles" />
		<mkdir dir="${felix}/fpai_bundles" />

		<get dest="${felix}/base_bundles/org.apache.felix.main-4.2.1.jar" src="http://apache.proserve.nl/felix/org.apache.felix.main-4.2.1.jar" />
		<repodownload repository="http://openemf.labsgn.tno.nl/ext-repo" gzipped="true" outDir="${felix}/base_bundles" full="false" />
		<!-- TODO: the appinfo is broken in the current release? -->
		<repodownload bndFile="${workspacedir}/cnf/ext/repositories.bnd" skip="ext-repo|ui.appinfo" outDir="${felix}/fpai_bundles" full="false" />
		<antcall target="deployment-extras" />

		<copy todir="${felix}/fpai_bundles" flatten="true">
			<fileset dir="${felix}/../release/">
				<include name="*/*.jar"/>
			</fileset>
		</copy>

		<!-- copy the configuration -->
		<copy todir="${felix}/etc">
			<fileset dir="${workspacedir}/cnf/deployment" />
		</copy>

		<echo file="${felix}/run.bat">
@echo off
title ${project.title}
echo ${project.title}
echo Running from %CD%

start "${project.title}" java ^
      -Djava.security.policy=etc/all.policy ^
      -Dfelix.config.properties=file:etc/config.properties ^
      -Dfelix.cm.dir="%CD%\config" ^
      -Dlogback.configurationFile=etc/logback.xml ^
      -jar base_bundles/org.apache.felix.main-4.2.1.jar
		</echo>
		<echo file="${felix}/run.sh">
#!/bin/bash
echo Running from `pwd`

java \
      -Djava.security.policy=etc/all.policy \
      -Dfelix.config.properties=file:etc/config.properties \
      -Dfelix.cm.dir="`pwd`\config" \
      -Dlogback.configurationFile=etc/logback.xml \
      -jar base_bundles/org.apache.felix.main-4.2.1.jar
		</echo>

		<zip basedir="${felix}" destfile="${baseDir}/${version}/${ant.project.name}-felix-runtime-${version}.zip">
			<include name="**" />
		</zip>
	</target>

	<target name="workspace" depends="init">		
		<!-- Make repositories local -->
		<repodownload bndFile="${workspacedir}/cnf/ext/repositories.bnd" changeBndFile="true" outDir="${workspacedir}/cnf/repos" full="true" />
		<!-- Mave bnd files to  -->
		<mkdir dir="${workspacedir}/cnf/bnd" />
		<copy todir="${workspacedir}/cnf/bnd">
			<fileset dir="${workspacedir}/cnf.shared/bnd"/>
		</copy>
		<replace file="${workspacedir}/cnf/ext/repositories.bnd" token="cnf.shared" value="cnf"/>
		
		<zip basedir=".." destfile="${baseDir}/${version}/${ant.project.name}-eclipse-workspace-${version}.zip">
			<exclude name="cnf.shared/**" />
			<exclude name="cnf/cache/**" />
			<exclude name="cnf/release/**" />
			<exclude name="*/bin/**" />
			<exclude name="*/generated/**" />
			<exclude name="**.git**" />
			<exclude name=".metadata/**" />
		</zip>
		<!-- undo changes -->
		<delete dir="${workspacedir}/cnf/repos" />
		<delete dir="${workspacedir}/cnf/bnd" />
		<delete file="${workspacedir}/cnf/ext/repositories.bnd" />
		<move file="${workspacedir}/cnf/ext/repositories.bnd.orig" tofile="${workspacedir}/cnf/ext/repositories.bnd" />
	</target>


	<target name="distribute" depends="init">
		<delete dir="${workspacedir}/cnf/release" />
		<mkdir dir="${workspacedir}/cnf/release" />
		<delete dir="${workspacedir}/cnf/cache" />
		<mkdir dir="${workspacedir}/cnf/cache" />

		<subant target="clean">
			<fileset refId="build" />
		</subant>
		<subant target="distribute">
			<fileset refId="build" />
		</subant>
		<property name="build.done" value="true" />
		<property name="release.done" value="true" />

		<subant target="test">
			<fileset dir="${workspacedir}">
				<include name="*.test/build.xml" />
			</fileset>
		</subant>

		<antcall target="publishrelease" />
		<antcall target="publishjavadoc" />
		<antcall target="deployment" />
	</target>

	<target name="snapshot">
		<property name="version" value="${targetversion}-SNAPSHOT" />
		<antcall target="distribute" />
	</target>

	<target name="nightly">
		<property name="version" value="${targetversion}-${DSTAMP}-NIGHTLY" />
		<antcall target="distribute" />
	</target>

	<target name="really-do-release">
		<property name="version" value="${targetversion}" />
		<antcall target="distribute" />
	</target>
</project>

